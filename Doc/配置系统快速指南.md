# Pek.Common 配置系统快速指南

## 快速入门

### 1. 创建配置类

```csharp
// 1. 创建JsonSerializerContext（AOT兼容）
[JsonSerializable(typeof(MyConfig))]
[JsonSerializable(typeof(string))]
[JsonSerializable(typeof(bool))]
[JsonSerializable(typeof(int))]
public partial class MyConfigJsonContext : JsonSerializerContext
{
}

// 2. 创建配置类
public class MyConfig : Config<MyConfig>
{
    // 配置属性
    public string? Name { get; set; } = "默认名称";
    public bool IsEnabled { get; set; } = false;
    
    // 3. 静态构造函数注册配置
    static MyConfig()
    {
        var options = new JsonSerializerOptions
        {
            TypeInfoResolver = MyConfigJsonContext.Default,
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };
        
        ConfigManager.RegisterConfig<MyConfig>(options);
    }
}
```

### 2. 使用配置

```csharp
// 获取配置实例
var config = MyConfig.Current;

// 读取配置
string name = config.Name;
bool isEnabled = config.IsEnabled;

// 修改配置
config.Name = "新名称";
config.IsEnabled = true;

// 保存配置
config.Save();

// 重新加载配置
MyConfig.Reload();
```

### 3. AOT兼容初始化

在程序启动时添加以下代码：

```csharp
private static void InitializeConfigs()
{
    try
    {
        // 手动注册配置
        var jsonOptions = new JsonSerializerOptions
        {
            TypeInfoResolver = MyConfigJsonContext.Default,
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };
        
        ConfigManager.RegisterConfig<MyConfig>(jsonOptions);
        
        // 触发初始化
        var config = MyConfig.Current;
        Console.WriteLine("✅ 配置初始化成功");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"⚠️ 配置初始化失败: {ex.Message}");
    }
}
```

## 配置文件

- **位置**：`应用程序根目录/Config/配置类名.config`
- **格式**：JSON

示例：
```json
{
  "name": "我的应用",
  "isEnabled": true
}
```

## 最佳实践

1. **提供默认值**：为所有配置属性设置合理的默认值
2. **使用可空类型**：对于可选配置项使用可空类型
3. **AOT兼容**：使用JsonSerializerContext并注册所有需要序列化的类型
4. **预初始化**：在应用程序启动时初始化所有配置类
5. **异常处理**：妥善处理配置加载和保存过程中可能出现的异常

## 常见问题

### 配置未加载

- 检查配置文件是否存在
- 确保已正确注册配置类
- 验证序列化选项是否正确

### AOT环境错误

- 确保创建了JsonSerializerContext
- 使用[JsonSerializable]注册所有类型
- 在程序启动时手动初始化配置

## 参考

详细文档请参阅：[配置系统说明文档.md](配置系统说明文档.md)